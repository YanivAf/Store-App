"use strict";exports.__esModule=!0,exports.Users=exports.User=exports.PurchasedCart=exports.CartProduct=void 0;var uuidv4=require("uuid").v4,fs=require("fs"),path=require("path"),usersJsonPath=path.resolve(__dirname,"../users.json"),_a=require("./storesModel"),Product=_a.Product,Store=_a.Store,Stores=_a.Stores,readUsersJson=function(){try{var s=fs.readFileSync(usersJsonPath);return JSON.parse(s)}catch(s){console.error(s.message)}},CartProduct=function(s,r){this.storeUuid=s,this.productUuid=r,this.quantity=1,this.status="Awaiting Shipping"};exports.CartProduct=CartProduct;var PurchasedCart=function(s,r){this.purchasedCartUuid=uuidv4(),this.purchasedCartProducts=s,this.shippingAddress=r,this.purchasedAt=new Date};exports.PurchasedCart=PurchasedCart;var User=function(s,r,t){this.userUuid=uuidv4(),this.email=s,this.username=r,this.shippingAddress="No. StreetName st., CityName, CountryName",this.password=t,this.stores=[],this.cart=[],this.purchasedCarts=[]};exports.User=User;var Users=function(){function s(){this.users=readUsersJson()}return s.prototype.updateUsersJson=function(){try{fs.writeFileSync(usersJsonPath,JSON.stringify(this.users))}catch(s){console.error(s.message)}},s.prototype.findUserIndex=function(r,t){try{return r?this.users.findIndex(function(s){return s.userUuid===r}):this.users.findIndex(function(s){return s.email===t})}catch(s){console.error(s.message)}},s.prototype.addUser=function(s,r,t,e,u,o){try{var a,i,n=new User(s,r,t),c=e?this.users[u].userUuid:n.userUuid,d=void 0;return"admin"===o?(i=(a=new Stores).addStore([c]),d=a.stores[i].storeUuid,e?this.users[u].stores.push(d):(n.stores.push(d),this.users.push(n)),a.updateStoresJson()):this.users.push(n),this.updateUsersJson(),{userUuid:c,storeUuid:d}}catch(s){console.error(s.message)}},s.prototype.addCartProduct=function(s,r,t){try{var e=new CartProduct(t,r);this.users[s].cart.push(e);var u=this.users[s].cart.length-1;return this.updateUsersJson(),u}catch(s){console.error(s.message)}},s.prototype.findCartProduct=function(s,r){try{return this.users[s].cart.findIndex(function(s){return s.productUuid===r})}catch(s){console.error(s.message)}},s.prototype.deleteCartProduct=function(s,r){try{this.users[s].cart=this.users[s].cart.filter(function(s){return s.productUuid!==r}),this.updateUsersJson()}catch(s){console.error(s.message)}},s.prototype.updateCartProductQuantity=function(s,r,t,e,u,o,a){try{var i=-1===r;i&&(r=this.addCartProduct(s,u,t));var n,c,d,h,p=new Stores,f=i?a:a-this.users[s].cart[r].quantity;return-1===a?(p.stores[e].products[o].inStock+=this.users[s].cart[r].quantity,this.deleteCartProduct(s,u)):(p.stores[e].products[o].inStock-=f,this.users[s].cart[r].quantity=a,n=this.users[s].cart[r].quantity,d=(c=p.stores[e].products[o].productPrice)-c*(p.stores[e].products[o].precentsOff/100),h=p.stores[e].products[o].productName,this.users[s].cart[r].totalPrice=n*d,this.users[s].cart[r].productName=h),p.updateStoresJson(),this.updateUsersJson(),this.users[s].cart}catch(s){console.error(s.message)}},s.prototype.addPurchesedCart=function(s){try{var r=this.users[s].cart.filter(function(s){return 0<s.quantity}),t=this.users[s].shippingAddress,e=new PurchasedCart(r,t);this.users[s].purchasedCarts.push(e);var u=this.users[s].email,o=this.users[s].username,a=this.users[s].userUuid;(new Stores).addPurchesedCart(e.purchasedCartUuid,r,t,u,o,a)}catch(s){console.error(s.message)}},s.prototype.emptyCart=function(s){try{this.addPurchesedCart(s),this.users[s].cart=this.users[s].cart.filter(function(s){return 0===s.quantity}),this.updateUsersJson()}catch(s){console.error(s.message)}},s}();exports.Users=Users;