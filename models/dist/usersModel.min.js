"use strict";exports.__esModule=!0,exports.Users=exports.User=exports.CartProduct=void 0;var uuidv4=require("uuid").v4,fs=require("fs"),path=require("path"),usersJsonPath=path.resolve(__dirname,"../users.json"),storeJsonPath=path.resolve(__dirname,"../store.json"),_a=require("./storeModel"),readStoreJson=_a.readStoreJson,Product=_a.Product,Store=_a.Store,readUsersJson=function(){try{var r=fs.readFileSync(usersJsonPath);return JSON.parse(r)}catch(r){console.error(r.message)}},CartProduct=function(r){this.productUuid=r,this.quantity=1};exports.CartProduct=CartProduct;var User=function(r,s,t){this.userUuid=uuidv4(),this.email=r,this.username=s,this.password=t,this.stores=[],this.cart=[],this.purchased=[]};exports.User=User;var Users=function(){function r(){this.users=readUsersJson()}return r.prototype.updateUsersJson=function(){try{fs.writeFileSync(usersJsonPath,JSON.stringify(this.users))}catch(r){console.error(r.message)}},r.prototype.verifyUser=function(s,t){try{var r=this.users.find(function(r){return r.email===s&&r.password===t});if(!r)throw new Error("credentials are wrong");return r}catch(r){console.error(r.message)}},r.prototype.findUserIndex=function(s,t){try{var r=s?this.users.findIndex(function(r){return r.userUuid===s}):this.users.findIndex(function(r){return r.email===t});if(-1===r&&s)throw new Error("no user with uuid "+s);return r}catch(r){console.error(r.message)}},r.prototype.storeUuid=function(){try{var r,s=this.users.findIndex(function(r){return 0<r.stores.length}),t=void 0;return-1===s?(t=uuidv4(),(r=readStoreJson()).storeUuid=t,fs.writeFileSync(storeJsonPath,JSON.stringify(r))):t=this.users[s].stores[0],t}catch(r){console.error(r.message)}},r.prototype.addUser=function(r,s,t,e){try{var u=new User(r,s,t),o=this.findUserIndex(null,r);if(e){if(-1!==o)return 0===this.users[o].stores.length&&this.users[o].username===s&&this.users[o].password===t?(this.users[o].stores.push(this.storeUuid()),this.updateUsersJson(),{userUuid:this.users[o].userUuid,storeUuid:this.users[o].stores[0]}):null;u.stores.push(this.storeUuid()),this.users.push(u)}else{if(-1!==o)return null;this.users.push(u)}return this.updateUsersJson(),{userUuid:u.userUuid,storeUuid:[]}}catch(r){console.error(r.message)}},r.prototype.addCartProduct=function(r,s){try{var t=this.findUserIndex(r,null),e=new CartProduct(s);this.users[t].cart.push(e),this.updateUsersJson()}catch(r){console.error(r.message)}},r.prototype.findCartProduct=function(r,s){try{var t=this.users[r].cart.findIndex(function(r){return r.productUuid===s});if(-1===t)throw new Error("product "+s+" wasn't found in cart");return t}catch(r){console.error(r.message)}},r.prototype.deleteCartProduct=function(r,s){try{var t=this.findUserIndex(r,null);this.findCartProduct(t,s);this.users[t].cart=this.users[t].cart.filter(function(r){return r.productUuid!==s}),this.updateUsersJson()}catch(r){console.error(r.message)}},r.prototype.updateCartProductQuantity=function(r,s,t){try{var e=this.findUserIndex(r,null),u=this.findCartProduct(e,s);return"+"===t?this.users[e].cart[u].quantity++:(this.users[e].cart[u].quantity--,0===this.users[e].cart[u].quantity&&this.deleteCartProduct(r,s)),this.updateUsersJson(),this.users[e].cart[u].quantity}catch(r){console.error(r.message)}},r.prototype.updatePurcased=function(t){var e=this;try{this.users[t].cart.forEach(function(s){var r=e.users[t].purchased.findIndex(function(r){return r.productUuid==s.productUuid});-1===r?e.users[t].purchased.push(s):e.users[t].purchased[r].quantity+=s.quantity});var u=readStoreJson();this.users[t].cart.forEach(function(s){var r=u.products.findIndex(function(r){return r.productUuid==s.productUuid});u.products[r].inStock-=s.quantity}),fs.writeFileSync(storeJsonPath,JSON.stringify(u))}catch(r){console.error(r.message)}},r.prototype.emptyCart=function(r){try{var s=this.findUserIndex(r,null);this.updatePurcased(s),this.users[s].cart=[],this.updateUsersJson()}catch(r){console.error(r.message)}},r}();exports.Users=Users;