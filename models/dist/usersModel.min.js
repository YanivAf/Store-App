"use strict";exports.__esModule=!0,exports.Users=exports.User=exports.CartProduct=exports.Store=void 0;var uuidv4=require("uuid").v4,fs=require("fs"),path=require("path"),usersJsonPath=path.resolve(__dirname,"../users.json"),storeJsonPath=path.resolve(__dirname,"../store.json"),readStoreJson=function(){try{var r=fs.readFileSync(storeJsonPath);return JSON.parse(r)}catch(r){console.error(r)}},Store=function(){};exports.Store=Store;var readUsersJson=function(){try{var r=fs.readFileSync(usersJsonPath);return JSON.parse(r)}catch(r){console.error(r)}},CartProduct=function(r){this.productUuid=r,this.quantity=1};exports.CartProduct=CartProduct;var User=function(r,t,s){this.userUuid=uuidv4(),this.email=r,this.username=t,this.password=s,this.storeUuid=null,this.cart=[],this.purchased=[]};exports.User=User;var Users=function(){function r(){this.users=readUsersJson()}return r.prototype.updateUsersJson=function(){try{fs.writeFileSync(usersJsonPath,JSON.stringify(this.users))}catch(r){console.error(r)}},r.prototype.verifyUser=function(t,s){try{var r=this.users.find(function(r){return r.email===t&&r.password===s});return r?r:void 0}catch(r){console.error(r)}},r.prototype.findUserIndex=function(t,s){try{var r=t?this.users.findIndex(function(r){return r.userUuid===t}):this.users.findIndex(function(r){return r.email===s});if(-1===r&&t)throw new Error("no user with uuid "+t);return r}catch(r){console.error(r)}},r.prototype.storeUuid=function(){try{var r,t=this.users.findIndex(function(r){return null!==r.storeUuid}),s=void 0;return-1===t?(s=uuidv4(),(r=readStoreJson()).storeUuid=s,fs.writeFileSync(storeJsonPath,JSON.stringify(r))):s=this.users[t].storeUuid,s}catch(r){console.error(r)}},r.prototype.addUser=function(r,t,s,e){try{var o=new User(r,t,s),u=this.findUserIndex(null,r);if(e){if(-1!==u)return null===this.users[u].storeUuid&&this.users[u].username===t&&this.users[u].password===s?(this.users[u].storeUuid=this.storeUuid(),this.updateUsersJson(),this.users[u].userUuid):null;o.storeUuid=this.storeUuid(),this.users.push(o)}else{if(-1!==u)return null;this.users.push(o)}return this.updateUsersJson(),o.userUuid}catch(r){console.error(r)}},r.prototype.addCartProduct=function(r,t){try{var s=this.findUserIndex(r,null),e=new CartProduct(t);this.users[s].cart.push(e),this.updateUsersJson()}catch(r){console.error(r)}},r.prototype.findCartProduct=function(r,t){try{var s=this.users[r].cart.findIndex(function(r){return r.productUuid===t});if(-1===s)throw new Error("product "+t+" wasn't found in cart");return s}catch(r){console.error(r)}},r.prototype.deleteCartProduct=function(r,t){try{var s=this.findUserIndex(r,null);this.findCartProduct(s,t);this.users[s].cart=this.users[s].cart.filter(function(r){return r.productUuid!==t}),this.updateUsersJson()}catch(r){console.error(r)}},r.prototype.updateCartProductQuantity=function(r,t,s){try{var e=this.findUserIndex(r,null),o=this.findCartProduct(e,t);"+"===s?this.users[e].cart[o].quantity++:(this.users[e].cart[o].quantity--,0===this.users[e].cart[o].quantity&&this.deleteCartProduct(r,t)),this.updateUsersJson()}catch(r){console.error(r)}},r.prototype.emptyCart=function(r){try{var t=this.findUserIndex(r,null);this.updatePurcased(t),this.users[t].cart=[],this.updateUsersJson()}catch(r){console.error(r)}},r.prototype.updatePurcased=function(r){var t;try{(t=this.users[r].purchased).push.apply(t,this.users[r].cart)}catch(r){console.error(r)}},r}();exports.Users=Users;