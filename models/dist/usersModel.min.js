"use strict";exports.__esModule=!0,exports.Users=exports.User=exports.PurchasedCart=exports.CartProduct=void 0;var uuidv4=require("uuid").v4,fs=require("fs"),path=require("path"),usersJsonPath=path.resolve(__dirname,"../users.json"),_a=require("./storesModel"),Product=_a.Product,Store=_a.Store,Stores=_a.Stores,readUsersJson=function(){try{var s=fs.readFileSync(usersJsonPath);return JSON.parse(s)}catch(s){console.error(s.message)}},CartProduct=function(s,r,t,e){this.storeUuid=s,this.productUuid=r,this.productName=t,this.inStockMirror=e,this.quantity=1,this.status="Awaiting Shipping",this.statusUpdatedAt=new Date};exports.CartProduct=CartProduct;var PurchasedCart=function(s,r){this.purchasedCartUuid=uuidv4(),this.purchasedCartProducts=s,this.shippingAddress=r,this.purchasedAt=new Date};exports.PurchasedCart=PurchasedCart;var User=function(s,r,t){this.userUuid=uuidv4(),this.email=s,this.username=r,this.shippingAddress="No. StreetName st., CityName, CountryName",this.password=t,this.stores=[],this.cart=[],this.savedForLater=[],this.loved=[],this.purchasedCarts=[]};exports.User=User;var Users=function(){function s(){this.users=readUsersJson()}return s.prototype.updateUsersJson=function(){try{fs.writeFileSync(usersJsonPath,JSON.stringify(this.users))}catch(s){console.error(s.message)}},s.prototype.findUserIndex=function(r,t){try{return r?this.users.findIndex(function(s){return s.userUuid===r}):this.users.findIndex(function(s){return s.email===t})}catch(s){console.error(s.message)}},s.prototype.addUser=function(s,r,t,e,o,u){try{var a,i,n=new User(s,r,t),d=e?this.users[o].userUuid:n.userUuid,c=void 0;return"admin"===u?(i=(a=new Stores).addStore([d],s),c=a.stores[i].storeUuid,e?this.users[o].stores.push(c):(n.stores.push(c),this.users.push(n)),a.updateStoresJson()):this.users.push(n),this.updateUsersJson(),{userUuid:d,storeUuid:c}}catch(s){console.error(s.message)}},s.prototype.addCartProduct=function(s,r,t,e,o){try{var u=new CartProduct(r,t,e,o);this.users[s].cart.push(u);var a=this.users[s].cart.length-1;return this.users[s].savedForLater=this.users[s].savedForLater.filter(function(s){return s!==t}),this.updateUsersJson(),a}catch(s){console.error(s.message)}},s.prototype.findCartProduct=function(s,r){try{return this.users[s].cart.findIndex(function(s){return s.productUuid===r})}catch(s){console.error(s.message)}},s.prototype.deleteCartProduct=function(s,r){try{this.users[s].cart=this.users[s].cart.filter(function(s){return s.productUuid!==r}),this.updateUsersJson()}catch(s){console.error(s.message)}},s.prototype.updateLovedProducts=function(s,r,t,e){try{var o=new Stores,u=this.users[s].loved.findIndex(function(s){return s===r});return-1===u?(this.users[s].loved.unshift(r),o.stores[t].products[e].loved++):(this.users[s].loved.splice(u,1),o.stores[t].products[e].loved--),this.updateUsersJson(),o.updateStoresJson(),this.users[s].loved}catch(s){console.error(s.message)}},s.prototype.saveForLater=function(s,r){try{this.users[s].savedForLater.unshift(r),this.updateUsersJson()}catch(s){console.error(s.message)}},s.prototype.unsaveForLater=function(s,r){try{return this.users[s].savedForLater=this.users[s].savedForLater.filter(function(s){return s!==r}),this.updateUsersJson(),this.users[s].savedForLater}catch(s){console.error(s.message)}},s.prototype.updateCartProductQuantity=function(s,r,t,e,o,u,a){try{var i=new Stores,n=-1===r;n&&1===this.users[s].cart.filter(function(s){return s.storeUuid===e}).length&&i.stores[t].createdCartsCounter++,r=n?this.users[s].cart.length-1:r;var d,c,h,p=n?a:a-this.users[s].cart[r].quantity;return a<0?(this.deleteCartProduct(s,o),-2===a&&this.saveForLater(s,o)):(this.users[s].cart[r].inStockMirror-=p,this.users[s].cart[r].quantity=a,d=this.users[s].cart[r].quantity,h=(c=i.stores[t].products[u].productPrice)-c*(i.stores[t].products[u].precentsOff/100),this.users[s].cart[r].totalPrice=d*h),i.updateStoresJson(),this.updateUsersJson(),this.users[s].cart}catch(s){console.error(s.message)}},s.prototype.addPurchesedCart=function(s){try{var r=this.users[s].cart,t=this.users[s].shippingAddress,e=new PurchasedCart(r,t);this.users[s].purchasedCarts.unshift(e);var o=this.users[s].email,u=this.users[s].username,a=this.users[s].userUuid;(new Stores).addPurchesedCart(e.purchasedCartUuid,r,t,o,u,a)}catch(s){console.error(s.message)}},s.prototype.emptyCart=function(s){try{this.addPurchesedCart(s),this.users[s].cart=[],this.updateUsersJson()}catch(s){console.error(s.message)}},s}();exports.Users=Users;